#!/usr/bin/env bash
# file-protector.sh - PreToolUse hook to prevent writes to sensitive files
#
# CONFIGURATION
#   Patterns loaded from ~/.claude/hook-config.json (fileProtector section)
#   Falls back to hardcoded defaults if config missing
#
# EXIT CODES
#   0 - Allow the operation
#   2 - Block with message (sent to Claude via stderr)

set -euo pipefail

CONFIG_FILE="$HOME/.claude/hook-config.json"
INPUT=$(cat)
FILE_PATH=$(echo "$INPUT" | jq -r '.tool_input.file_path // .tool_input.path // ""' 2>/dev/null || echo "")

# Exit early if no file path
[[ -z "$FILE_PATH" ]] && exit 0

# Load patterns from config or use defaults
load_patterns() {
	local section="$1"
	local default_patterns="$2"

	if [[ -f "$CONFIG_FILE" ]] && command -v jq &>/dev/null; then
		local patterns
		patterns=$(jq -r ".fileProtector.${section}[]?" "$CONFIG_FILE" 2>/dev/null)
		if [[ -n "$patterns" ]]; then
			echo "$patterns"
			return
		fi
	fi
	echo "$default_patterns"
}

# Default protected patterns (used if config missing)
DEFAULT_PROTECTED='\.env$
\.env\.
/\.env$
secrets/
secret[s]?\.
\.key$
\.pem$
\.p12$
\.pfx$
\.ssh/
id_rsa
id_ed25519
credentials
password
\.secret$
api[_-]?key
auth[_-]?token'

# Default lock file patterns
DEFAULT_LOCKS='package-lock\.json$
yarn\.lock$
pnpm-lock\.yaml$
go\.sum$
Cargo\.lock$
poetry\.lock$
Gemfile\.lock$
composer\.lock$'

# Load patterns
PROTECTED_PATTERNS=$(load_patterns "protectedPatterns" "$DEFAULT_PROTECTED")
LOCK_PATTERNS=$(load_patterns "lockFilePatterns" "$DEFAULT_LOCKS")

# Check protected patterns - BLOCK
while IFS= read -r pattern; do
	[[ -z "$pattern" ]] && continue
	if [[ "$FILE_PATH" =~ $pattern ]]; then
		echo "BLOCKED: Cannot modify sensitive file: $FILE_PATH" >&2
		echo "Pattern matched: $pattern" >&2
		echo "To customize: edit ~/.claude/hook-config.json (fileProtector.protectedPatterns)" >&2
		exit 2
	fi
done <<<"$PROTECTED_PATTERNS"

# Check lock files - WARN but allow
while IFS= read -r pattern; do
	[[ -z "$pattern" ]] && continue
	if [[ "$FILE_PATH" =~ $pattern ]]; then
		echo "WARNING: Modifying lock file: $FILE_PATH" >&2
		echo "Lock files should typically be auto-generated by package managers" >&2
		exit 0
	fi
done <<<"$LOCK_PATTERNS"

exit 0
